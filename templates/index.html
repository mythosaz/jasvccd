<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>jasvccd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        :root {
            --bg: #0f172a;
            --fg: #e5e7eb;
            --muted: #a5b4fc;
            --card: #0b162f;
            --card-border: #1f2937;
            --accent: #10b981;
            --subtle: #9ca3af;
            --input: #1f2937;
        }
        body.light {
            --bg: #f8fafc;
            --fg: #0f172a;
            --muted: #4338ca;
            --card: #ffffff;
            --card-border: #e2e8f0;
            --accent: #059669;
            --subtle: #475569;
            --input: #e2e8f0;
        }
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 1rem;
            background: var(--bg);
            color: var(--fg);
            transition: background 0.25s ease, color 0.25s ease;
        }
        .page {
            max-width: 960px;
            margin: 0 auto;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .logo {
            width: 80%;
            max-width: 720px;
            min-width: 240px;
            height: auto;
        }
        #theme-toggle {
            background: var(--input);
            color: var(--fg);
            border: 1px solid var(--card-border);
        }
        main {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #dropzone {
            border: 2px dashed #6b7280;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
        }
        #dropzone.dragover {
            border-color: var(--accent);
            background: rgba(16, 185, 129, 0.06);
        }
        video {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: black;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        input[type="range"] {
            flex: 1;
        }
        button {
            background: var(--input);
            color: var(--fg);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 0.35rem 0.75rem;
            cursor: pointer;
        }
        button.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #022c22;
            font-weight: 600;
        }
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        small {
            color: var(--subtle);
        }
        footer {
            margin-top: 1.5rem;
            color: var(--subtle);
            font-size: 0.9rem;
        }
        footer a {
            color: var(--muted);
        }
        .attrib {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, rgba(12, 19, 42, 0.92), rgba(9, 13, 30, 0.94));
            border: 1px solid var(--card-border);
            padding: 0.85rem 1rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            width: min(780px, 95%);
            margin: 0 auto;
            color: var(--fg);
        }
        body.light .attrib {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.12);
        }
        .attrib a {
            color: var(--muted);
            font-weight: 600;
        }
        .attrib-icon {
            width: 18px;
            height: 18px;
            vertical-align: middle;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.25));
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <img class="logo" src="/static/jasvccd.svg" alt="JASVCCD">
        <button id="theme-toggle" aria-label="Toggle theme">ðŸŒ—</button>
    </header>

    <main>
        <div id="dropzone">
            <p>Drop a video here or click to choose.</p>
            <input id="file-input" type="file" accept="video/*" style="display:none;">
        </div>

        <video id="video" controls hidden></video>

        <div id="ui" class="controls" hidden>
            <div class="row">
                <label style="width:80px;">Start</label>
                <input id="start-range" type="range" min="0" max="0" step="0.05">
                <span id="start-label">0.0s</span>
                <button id="set-start">From playhead</button>
            </div>
            <div class="row">
                <label style="width:80px;">End</label>
                <input id="end-range" type="range" min="0" max="0" step="0.05">
                <span id="end-label">0.0s</span>
                <button id="set-end">From playhead</button>
            </div>
            <div class="row">
                <small>Video duration: <span id="duration-label">0.0</span>s</small>
            </div>
            <div class="row">
                <button id="preview">Preview segment</button>
                <button id="cut" class="primary">Cut &amp; Download</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="attrib">
            <div>
                Credits & source on <a href="https://github.com/mythosaz/jasvccd/" target="_blank" rel="noopener">GitHub</a>
            </div>
            <div>
                <img class="attrib-icon" src="/static/Octicons-mark-github.svg" alt="GitHub icon"> Open source â€¢
                <img class="attrib-icon" src="/static/FFmpeg_Logo_new.svg" alt="FFmpeg logo"> Powered by FFmpeg â€¢
                <img class="attrib-icon" src="/static/Flask_logo.svg" alt="Flask logo"> Served with Flask
            </div>
        </div>
    </footer>
</div>

<script>
(() => {
    const themeToggle = document.getElementById("theme-toggle");
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("file-input");
    const video = document.getElementById("video");
    const ui = document.getElementById("ui");

    const startRange = document.getElementById("start-range");
    const endRange = document.getElementById("end-range");
    const startLabel = document.getElementById("start-label");
    const endLabel = document.getElementById("end-label");
    const durationLabel = document.getElementById("duration-label");

    const btnSetStart = document.getElementById("set-start");
    const btnSetEnd = document.getElementById("set-end");
    const btnPreview = document.getElementById("preview");
    const btnCut = document.getElementById("cut");

    let videoMeta = null; // { id, ext, duration, url }
    let previewing = false;

    function setTheme(mode) {
        const isLight = mode === "light";
        document.body.classList.toggle("light", isLight);
        localStorage.setItem("theme", isLight ? "light" : "dark");
        themeToggle.textContent = isLight ? "ðŸŒž" : "ðŸŒ™";
    }

    function initTheme() {
        const stored = localStorage.getItem("theme");
        if (stored === "light" || stored === "dark") {
            setTheme(stored);
            return;
        }
        const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        setTheme(prefersLight ? "light" : "dark");
    }

    themeToggle.addEventListener("click", () => {
        const next = document.body.classList.contains("light") ? "dark" : "light";
        setTheme(next);
    });

    function fmt(t) {
        return t.toFixed(2);
    }

    function wireDropzone() {
        dropzone.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", e => {
            if (e.target.files && e.target.files[0]) {
                uploadFile(e.target.files[0]);
            }
        });

        ["dragenter", "dragover"].forEach(ev => {
            dropzone.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.add("dragover");
            });
        });
        ["dragleave", "drop"].forEach(ev => {
            dropzone.addEventListener(ev, e => {
                e.preventDefault();
                e.stopPropagation();
                dropzone.classList.remove("dragover");
            });
        });
        dropzone.addEventListener("drop", e => {
            const file = e.dataTransfer.files[0];
            if (file) uploadFile(file);
        });
    }

    async function uploadFile(file) {
        btnCut.disabled = true;
        btnPreview.disabled = true;
        dropzone.innerHTML = "<p>Uploadingâ€¦</p>";

        const form = new FormData();
        form.append("file", file);
        const resp = await fetch("/upload", {
            method: "POST",
            body: form
        });
        if (!resp.ok) {
            dropzone.innerHTML = "<p>Upload failed.</p>";
            return;
        }
        videoMeta = await resp.json();

        // Load video
        video.src = videoMeta.url;
        video.hidden = false;
        ui.hidden = false;

        const duration = videoMeta.duration;
        startRange.min = 0;
        startRange.max = duration;
        endRange.min = 0;
        endRange.max = duration;
        startRange.value = 0;
        endRange.value = duration;
        startLabel.textContent = "0.00s";
        endLabel.textContent = fmt(duration) + "s";
        durationLabel.textContent = fmt(duration);

        dropzone.innerHTML = "<p>Drop another video to replace.</p>";
        btnCut.disabled = false;
        btnPreview.disabled = false;
    }

    function syncLabels() {
        const start = parseFloat(startRange.value);
        const end = parseFloat(endRange.value);
        if (end < start) {
            endRange.value = start;
        }
        startLabel.textContent = fmt(parseFloat(startRange.value)) + "s";
        endLabel.textContent = fmt(parseFloat(endRange.value)) + "s";
    }

    startRange.addEventListener("input", syncLabels);
    endRange.addEventListener("input", syncLabels);

    btnSetStart.addEventListener("click", () => {
        if (videoMeta) {
            startRange.value = Math.min(video.currentTime, parseFloat(endRange.value));
            syncLabels();
        }
    });

    btnSetEnd.addEventListener("click", () => {
        if (videoMeta) {
            endRange.value = Math.max(video.currentTime, parseFloat(startRange.value));
            syncLabels();
        }
    });

    btnPreview.addEventListener("click", () => {
        if (!videoMeta) return;
        const start = parseFloat(startRange.value);
        const end = parseFloat(endRange.value);
        if (end <= start) return;

        previewing = true;
        video.currentTime = start;
        video.play();
    });

    video.addEventListener("timeupdate", () => {
        if (!previewing) return;
        const end = parseFloat(endRange.value);
        if (video.currentTime >= end) {
            video.pause();
            previewing = false;
        }
    });

    btnCut.addEventListener("click", async () => {
        if (!videoMeta) return;
        btnCut.disabled = true;
        btnCut.textContent = "Cuttingâ€¦";

        const start = parseFloat(startRange.value);
        const end = parseFloat(endRange.value);

        const resp = await fetch("/cut", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id: videoMeta.id,
                ext: videoMeta.ext,
                start: start,
                end: end
            })
        });

        if (!resp.ok) {
            alert("Cut failed.");
            btnCut.disabled = false;
            btnCut.textContent = "Cut & Download";
            return;
        }

        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "clip.mp4";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        btnCut.disabled = false;
        btnCut.textContent = "Cut & Download";
    });

    initTheme();
    wireDropzone();
})();
</script>
</body>
</html>
